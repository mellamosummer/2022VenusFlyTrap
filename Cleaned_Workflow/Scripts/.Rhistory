ungroup()
Expressed_genes <- Exp_table_long %>%
filter(tpm > 5) %>%
group_by(gene_ID) %>%
count() %>%
filter(n >= 2)
dim(Expressed_genes)
high_var_genes <- Exp_table_long_averaged_z %>%
filter(gene_ID %in% Expressed_genes$gene_ID) %>%
group_by(gene_ID) %>%
summarise(var = var(mean.logTPM)) %>%
ungroup() %>%
filter(var > quantile(var,0.5))
Exp_table_long_averaged_z_high_var <- Exp_table_long_averaged_z %>%
filter(gene_ID %in% high_var_genes$gene_ID)
head(Exp_table_long_averaged_z_high_var)
Exp_table_long_averaged_z_high_var %>%
group_by(gene_ID) %>%
count() %>%
nrow()
network_modules <- read_csv("/Users/summerblanco/Desktop/Github/2022VenusFlyTrap/Cleaned_Workflow/Results/GeneCoexpressionAnalysis/NetworkModules/network_modules_annotated.csv")
my_network_modules <- read_csv("/Users/summerblanco/Desktop/Github/2022VenusFlyTrap/Cleaned_Workflow/Results/GeneCoexpressionAnalysis/NetworkModules/network_modules_annotated.csv")
Exp_table_long_averaged_z_high_var_or_high_F_modules <- Exp_table_long_averaged_z_high_var_or_high_F %>%
inner_join(my_network_modules, by = "gene_ID")
z_score_wide <- Exp_table_long_averaged_z_high_var_or_high_F %>%
mutate(tag = paste(Time, Treatment, sep = "-")) %>%
select(gene_ID, tag, z.score) %>%
pivot_wider(names_from = tag, values_from = z.score) %>%
as.data.frame()
Exp_table_long_averaged_z_high_var_or_high_F <- Exp_table_long_averaged_z %>%
filter(gene_ID %in% high_var_or_high_F_genes$gene_ID)
high_var_or_high_F_genes <- F_high_var_comparison %>%
filter(type != "neither")
head(Exp_table_long_averaged_z_high_var)
Exp_table_long_averaged_z_high_var %>%
group_by(gene_ID) %>%
count() %>%
nrow()
compute_F <- function(data, gene){
anova_table = lm(logTPM ~ Time:Treatment, data %>%
filter(gene_ID == gene)) %>%
anova()
cbind(anova_table$`F value`[1], anova_table$`Pr(>F)`[1]) %>%
as.data.frame()
}
ANOVA_results <- purrr::map_dfr(
.x = Expressed_genes$gene_ID,
.f = compute_F,
data =  Exp_table_long %>%
full_join(PCA_coord, by = "LibraryName")
) %>%
cbind(gene_ID = Expressed_genes$gene_ID) %>%
as.data.frame() %>%
rename(
F_stat = V1,
p.value = V2
) %>%
mutate(FDR = p.adjust(p.value, method = "fdr"))
F_high_var_comparison <- ANOVA_results %>%
left_join(all_var_and_ranks, by = "gene_ID") %>%
mutate(high_F = case_when(
F_stat >= 2 ~ "high F",
T ~ "low F"
)) %>%
mutate(high_var = case_when(
gene_ID %in% high_var_genes$gene_ID ~ "high var",
T ~ "low var"
)) %>%
mutate(type = case_when(
high_F == "high F" &
high_var == "high var" ~ "both",
high_F == "high F" &
high_var == "low var" ~ "high F only",
high_F == "low F" &
high_var == "high var" ~ "high var only",
T ~ "neither"
))
all_var_and_ranks <- Exp_table_long_averaged_z %>%
group_by(gene_ID) %>%
summarise(var = var(mean.logTPM)) %>%
ungroup() %>%
mutate(rank = rank(var, ties.method = "average"))
F_high_var_comparison <- ANOVA_results %>%
left_join(all_var_and_ranks, by = "gene_ID") %>%
mutate(high_F = case_when(
F_stat >= 2 ~ "high F",
T ~ "low F"
)) %>%
mutate(high_var = case_when(
gene_ID %in% high_var_genes$gene_ID ~ "high var",
T ~ "low var"
)) %>%
mutate(type = case_when(
high_F == "high F" &
high_var == "high var" ~ "both",
high_F == "high F" &
high_var == "low var" ~ "high F only",
high_F == "low F" &
high_var == "high var" ~ "high var only",
T ~ "neither"
))
F_var_scatter <- F_high_var_comparison %>%
ggplot(aes(x = F_stat, y = sqrt(var))) +
geom_point(aes(color = type), alpha = 0.5) +
scale_color_manual(values = brewer.pal(n = 8, "Set2")) +
labs(x = "F stat",
y = "sd(log10(TPM))",
color = NULL) +
theme_classic() +
theme(
legend.position = c(0.75, 0.75),
text = element_text(size = 14),
axis.text = element_text(color = "black")
)
F_var_scatter
F_dist <- F_high_var_comparison %>%
ggplot(aes(x = F_stat)) +
geom_histogram(bins = 100, fill = brewer.pal(8, "Set2")[2]) +
labs(x = NULL) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black")
)
F_dist
var_dist <- F_high_var_comparison %>%
ggplot(aes(x = sqrt(var))) +
geom_histogram(bins = 100, fill = brewer.pal(8, "Set2")[3]) +
labs(x = NULL) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black")
) +
coord_flip()
var_dist
F_high_var_comparison %>%
group_by(type) %>%
count()
F_high_var_comparison %>%
group_by(high_var) %>%
count()
F_high_var_comparison %>%
group_by(high_F) %>%
count()
high_F_only_examples <- F_high_var_comparison %>%
filter(type == "high F only") %>%
slice_max(order_by = F_stat, n = 1) %>%
inner_join(Exp_table_long, by = "gene_ID") %>%
inner_join(PCA_coord, by = "LibraryName")
high_var_only_examples <- F_high_var_comparison %>%
filter(type == "high var only") %>%
slice_max(order_by = var, n = 1) %>%
inner_join(Exp_table_long, by = "gene_ID") %>%
inner_join(PCA_coord, by = "LibraryName")
high_var_high_F_examples <- F_high_var_comparison %>%
filter(type == "both") %>%
slice_max(order_by = F_stat, n = 1) %>%
inner_join(Exp_table_long, by = "gene_ID") %>%
inner_join(PCA_coord, by = "LibraryName")
neither_examples <- F_high_var_comparison %>%
filter(type == "neither") %>%
slice_max(order_by = var, n = 1) %>%
inner_join(Exp_table_long, by = "gene_ID") %>%
inner_join(PCA_coord, by = "LibraryName")
high_F_only_graphs <- high_F_only_examples %>%
ggplot(aes(x = Time, y = logTPM)) +
geom_point(aes(fill = Treatment), shape = 21, color = "white",
size = 3, alpha = 0.8, position = position_jitter(0.2, seed = 666)) +
scale_fill_manual(values = c("grey70", "tomato1")) +
labs(x = "time point",
y = "log10(TPM)",
title = paste0("high F only example\n",
high_F_only_examples$gene_ID)) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
plot.title = element_text(size = 12)
)
high_var_only_graphs <- high_var_only_examples %>%
ggplot(aes(x = Time, y = logTPM)) +
geom_point(aes(fill = Treatment), shape = 21, color = "white",
size = 3, alpha = 0.8, position = position_jitter(0.2, seed = 666)) +
scale_fill_manual(values = c("grey70", "tomato1")) +
labs(x = "time point",
y = "log10(TPM)",
title = paste0("high var only example\n",
high_var_only_examples$gene_ID)) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
plot.title = element_text(size = 12)
)
high_var_high_F_graphs <- high_var_high_F_examples %>%
ggplot(aes(x = Time, y = logTPM)) +
geom_point(aes(fill = Treatment), shape = 21, color = "white",
size = 3, alpha = 0.8, position = position_jitter(0.2, seed = 666)) +
scale_fill_manual(values = c("grey70", "tomato1")) +
labs(x = "time point",
y = "log10(TPM)",
title = paste0("high F high var example\n",
high_var_high_F_examples$gene_ID)) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
plot.title = element_text(size = 12)
)
low_var_low_F_graphs <- neither_examples %>%
ggplot(aes(x = Time, y = logTPM)) +
geom_point(aes(fill = Treatment), shape = 21, color = "white",
size = 3, alpha = 0.8, position = position_jitter(0.2, seed = 666)) +
scale_fill_manual(values = c("grey70", "tomato1")) +
labs(x = "time point",
y = "log10(TPM)",
title = paste0("low F low var example\n",
neither_examples$gene_ID)) +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
plot.title = element_text(size = 12)
)
high_var_or_high_F_genes <- F_high_var_comparison %>%
filter(type != "neither")
dim(high_var_or_high_F_genes)
Exp_table_long_averaged_z_high_var_or_high_F <- Exp_table_long_averaged_z %>%
filter(gene_ID %in% high_var_or_high_F_genes$gene_ID)
head(Exp_table_long_averaged_z_high_var_or_high_F)
z_score_wide <- Exp_table_long_averaged_z_high_var_or_high_F %>%
mutate(tag = paste(Time, Treatment, sep = "-")) %>%
select(gene_ID, tag, z.score) %>%
pivot_wider(names_from = tag, values_from = z.score) %>%
as.data.frame()
row.names(z_score_wide) <- z_score_wide$gene_ID
head(z_score_wide)
Exp_table_long_averaged_z_high_var_or_high_F_modules <- Exp_table_long_averaged_z_high_var_or_high_F %>%
inner_join(my_network_modules, by = "gene_ID")
head(Exp_table_long_averaged_z_high_var_or_high_F_modules)
modules_mean_z <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
group_by(module, Time, Treatment) %>%
summarise(mean.z = mean(z.score)) %>%
ungroup()
head(modules_mean_z)
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1)
module_peak_exp
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey"))) %>%
filter(module == "3") %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(Treatment ~ module) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
filter(module == "3") %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
modules_mean_z$mean.z %>% summary()
quantile(modules_mean_z$mean.z, c(0.05, 0.95))
modules_mean_z <- modules_mean_z %>%
mutate(mean.z.clipped = case_when(
mean.z > 1.5 ~ 1.5,
mean.z < -1.5 ~ -1.5,
T ~ mean.z
))
modules_mean_z_reordered <- modules_mean_z %>%
full_join(module_peak_exp %>%
rename(peak_time = Time) %>%
select(module, peak_time), by = "module") %>%
mutate(module = reorder(module, -peak_time))
head(modules_mean_z_reordered)
module_line_plots <- modules_mean_z_reordered %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey"))) %>%
filter(module == "3") %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(Treatment ~ module) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
filter(module == "3") %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(Treatment ~ module) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
filter(module == "3") %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
module_line_plots
module_line_plots
View(Exp_table_long_averaged_z_high_var_or_high_F_modules)
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(~forcats::fct_relevel(module, "460", "9", "7", "2", "168", "24", "6", "5", "16", "10", "4", "142", "13", "3")) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(~forcats::fct_relevel(Exp_table_long_averaged_z_high_var_or_high_F_modules$module, "460", "9", "7", "2", "168", "24", "6", "5", "16", "10", "4", "142", "13", "3")) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
ggplot(aes(x = Time, y = z.score)) +
facet_wrap(~forcats::fct_relevel(Exp_table_long_averaged_z_high_var_or_high_F_modules$module, "460", "9", "7", "2", "168", "24", "6", "5", "16", "10", "4", "142", "13", "3")) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
mutate(order_x = case_when(
str_detect(module, "460") ~ 1,
str_detect(module, "9") ~ 2,
str_detect(module, "7") ~ 3,
str_detect(module, "2") ~ 4,
str_detect(module, "168") ~ 5,
str_detect(module, "24") ~ 6,
str_detect(module, "6") ~ 7,
str_detect(module, "5") ~ 8,
str_detect(module, "16") ~ 9
str_detect(module, "10") ~ 10
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
mutate(order_x = case_when(
str_detect(module, "460") ~ 1,
str_detect(module, "9") ~ 2,
str_detect(module, "7") ~ 3,
str_detect(module, "2") ~ 4,
str_detect(module, "168") ~ 5,
str_detect(module, "24") ~ 6,
str_detect(module, "6") ~ 7,
str_detect(module, "5") ~ 8,
str_detect(module, "16") ~ 9,
str_detect(module, "10") ~ 10,
str_detect(module, "4") ~ 11,
str_detect(module, "142") ~ 12,
str_detect(module, "13") ~ 13,
str_detect(module, "3") ~ 14
)) %>%
mutate(module = reorder(module, order_x)) %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(Treatment ~ module) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
ggsave("module_line_plots_ordered.png", height = 20, width = 40, bg = "white")
module_peak_exp
module_peak_exp <-
modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = Time, n = 1)
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1)
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1) %>%
module_peak_exp
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1) %>%
module_peak_exp
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1) %>%
module_peak_exp
module_peak_exp <- modules_mean_z %>%
group_by(module) %>%
slice_max(order_by = mean.z, n = 1)
module_peak_exp
module_line_plots <- Exp_table_long_averaged_z_high_var_or_high_F_modules %>%
mutate(treatment = factor(Treatment, levels = c("prey", "no prey")))  %>%
mutate(order_x = case_when(
str_detect(module, "2") ~ 1,
str_detect(module, "7") ~ 2,
str_detect(module, "9") ~ 3,
str_detect(module, "14") ~ 4,
str_detect(module, "168") ~ 5,
str_detect(module, "24") ~ 6,
str_detect(module, "6") ~ 7,
str_detect(module, "5") ~ 8,
str_detect(module, "16") ~ 9,
str_detect(module, "10") ~ 10,
str_detect(module, "4") ~ 11,
str_detect(module, "142") ~ 12,
str_detect(module, "13") ~ 13,
str_detect(module, "3") ~ 14
)) %>%
mutate(module = reorder(module, order_x)) %>%
ggplot(aes(x = Time, y = z.score)) +
facet_grid(Treatment ~ module) +
geom_line(aes(group = gene_ID), alpha = 0.3, color = "grey70") +
geom_line(
data = modules_mean_z %>%
mutate(Treatment = factor(Treatment, levels = c("prey", "no prey"))),
aes(y = mean.z, group = module),
size = 1.1, alpha = 0.8
) +
labs(x = "time point",
y = "z score") +
theme_classic() +
theme(
text = element_text(size = 14),
axis.text = element_text(color = "black"),
#axis.text.x = element_blank(),
panel.spacing = unit(1, "line")
)
module_line_plots
